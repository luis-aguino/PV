<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aprende Phrasal Verbs</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }

        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="bg-gray-800 p-6 sm:p-8 lg:p-10 rounded-3xl shadow-2xl max-w-lg w-full flex flex-col items-center text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">Aprende Phrasal Verbs</h1>
        <p class="text-gray-300 mb-8 max-w-xs sm:max-w-none">Memoriza los phrasal verbs más comunes usados en diferentes regiones.</p>

        <!-- Selección de modo y bloque -->
        <div id="selection-container" class="w-full">
            <h2 class="text-xl font-semibold text-white mb-4">Elige el modo de estudio:</h2>
            <div id="mode-buttons-container" class="flex flex-col space-y-4 w-full mb-8">
                <button data-mode="quiz" class="mode-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Modo Examen</button>
                <button data-mode="writing" class="mode-button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Práctica de Escritura</button>
            </div>
            
            <div id="mode-selection" class="flex flex-col space-y-4 w-full hidden">
                <h2 class="text-xl font-semibold text-white">Elige el bloque de phrasal verbs:</h2>
                <button data-set="us" class="set-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Estados Unidos y Canadá</button>
                <button data-set="uk" class="set-button bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Reino Unido</button>
                <button data-set="all" class="set-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Ambos</button>
            </div>
        </div>

        <!-- Contenedor del Examen de Opción Múltiple -->
        <div id="quiz-container" class="w-full hidden">
            <div id="phrasal-verb-container" class="bg-gray-700 p-6 sm:p-8 rounded-2xl w-full mb-6 relative">
                <button id="audio-button-quiz" class="absolute top-4 right-4 bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-full transition-colors duration-200" title="Escuchar pronunciación">
                    <svg id="speaker-icon-quiz" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.899a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.293-4.293a1 1 0 011.414 0z" />
                    </svg>
                </button>
                <span id="loading-text-quiz" class="absolute top-4 right-14 text-sm text-gray-400 hidden">Cargando...</span>
                <p id="spanish-definition-quiz" class="text-xl sm:text-2xl font-semibold text-gray-200 mb-2"></p>
                <p id="example-sentence-quiz" class="text-lg text-gray-400 italic cursor-pointer"></p>
                <p id="gemini-loading-quiz" class="text-lg text-gray-400 italic hidden">Generando nuevo ejemplo...</p>
            </div>
            
            <button id="gemini-new-example-button-quiz" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full mb-4 flex justify-center items-center gap-2">
                <span id="gemini-button-text-quiz">Generar nuevo ejemplo ✨</span>
                <div id="gemini-spinner-quiz" class="loading-spinner hidden"></div>
            </button>


            <div id="choices-container" class="flex flex-col space-y-4 w-full"></div>
            
            <p id="feedback-quiz" class="h-6 text-sm font-medium mt-4 mb-2 transition-opacity duration-300"></p>
            <div id="motivation-container-quiz" class="cursor-pointer">
                <p id="motivation-quiz-es" class="h-6 text-sm text-gray-400 italic transition-opacity duration-300"></p>
                <p id="motivation-quiz-en" class="h-6 text-sm text-gray-400 italic transition-opacity duration-300 hidden"></p>
            </div>

            <div class="mt-8 text-lg font-bold text-white">
                <span id="score-text-quiz">Puntuación: 0</span> / <span id="total-text-quiz">0</span>
            </div>
        </div>

        <!-- Contenedor de Práctica de Escritura -->
        <div id="writing-container" class="w-full hidden">
            <div class="bg-gray-700 p-6 sm:p-8 rounded-2xl w-full mb-6">
                <p id="spanish-definition-writing" class="text-xl sm:text-2xl font-semibold text-gray-200 mb-4"></p>
                <p id="example-sentence-writing" class="text-lg text-gray-400 italic cursor-pointer"></p>
                <input type="text" id="answer-input" placeholder="Escribe el phrasal verb aquí..." class="w-full bg-gray-600 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400">
            </div>

            <div id="gemini-feedback-container-writing" class="bg-gray-700 p-4 rounded-xl mt-4 hidden">
                <p class="text-sm font-semibold text-white mb-2">Feedback de la IA:</p>
                <p id="gemini-feedback-writing" class="text-sm text-gray-300"></p>
            </div>
            
            <button id="check-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full mt-4">Comprobar</button>
            <button id="gemini-check-button-writing" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full mt-4 flex justify-center items-center gap-2">
                <span id="gemini-check-button-text">Verificar mi oración ✨</span>
                <div id="gemini-check-spinner" class="loading-spinner hidden"></div>
            </button>


            <div id="writing-feedback-container" class="mt-4 w-full">
                <p id="feedback-writing" class="h-6 text-sm font-medium transition-opacity duration-300 mb-2"></p>
                <div id="motivation-container-writing" class="cursor-pointer">
                    <p id="motivation-writing-es" class="h-6 text-sm text-gray-400 italic transition-opacity duration-300"></p>
                    <p id="motivation-writing-en" class="h-6 text-sm text-gray-400 italic transition-opacity duration-300 hidden"></p>
                </div>
                <div id="answer-reveal-container" class="bg-gray-700 p-4 rounded-xl mt-4 hidden">
                    <p class="text-lg font-semibold text-gray-200">Respuesta correcta: <span id="correct-answer-text" class="font-bold text-blue-400"></span></p>
                    <button id="audio-button-writing" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-full mt-2 transition-colors duration-200" title="Escuchar pronunciación">
                        <svg id="speaker-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.899a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.293-4.293a1 1 0 011.414 0z" />
                        </svg>
                    </button>
                    <span id="loading-text" class="text-sm text-gray-400 hidden">Cargando...</span>
                </div>
            </div>
        </div>

        <!-- Botones de navegación (compartidos) -->
        <div id="nav-buttons-container" class="w-full flex justify-between space-x-4 mt-6 hidden">
            <button id="back-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 flex-1 disabled:opacity-50 disabled:cursor-not-allowed">Atrás</button>
            <button id="next-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 flex-1">Siguiente</button>
            <button id="home-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-transform transform hover:scale-105 flex-1">Inicio</button>
        </div>
    </div>

    <!-- Modal de fin de set -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden modal z-50">
        <div class="bg-gray-800 p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full">
            <h2 id="modal-title" class="text-2xl font-bold text-white mb-4"></h2>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <button id="modal-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform transform hover:scale-105 w-full">Reiniciar</button>
        </div>
    </div>

    <script>
        // Array de phrasal verbs de Estados Unidos y Canadá
        const usPhrasalVerbs = [
            { english: "break down", spanish: "averiarse, descomponerse", example: "Mi coche se averió en el camino a casa.", english_example: "My car broke down on the way home." },
            { english: "look for", spanish: "buscar", example: "Estoy buscando mis llaves.", english_example: "I'm looking for my keys." },
            { english: "get up", spanish: "levantarse", example: "Me levanto a las 7 a.m. todos los días.", english_example: "I get up at 7 a.m. every day." },
            { english: "take off", spanish: "despegar (avión), quitarse (ropa)", example: "El avión despegará en 10 minutos.", english_example: "The plane will take off in 10 minutes." },
            { english: "put on", spanish: "ponerse (ropa)", example: "Me pondré un abrigo porque hace frío.", english_example: "I'll put on a coat because it's cold." },
            { english: "turn off", spanish: "apagar", example: "Recuerda apagar las luces antes de salir.", english_example: "Remember to turn off the lights before you leave." },
            { english: "turn on", spanish: "encender", example: "Enciende la televisión, por favor.", english_example: "Turn on the TV, please." },
            { english: "go on", spanish: "continuar", example: "Puedes continuar con tu historia.", english_example: "You can go on with your story." },
            { english: "call off", spanish: "cancelar", example: "Tuvieron que cancelar el partido por la lluvia.", english_example: "They had to call off the game because of the rain." },
            { english: "give up", spanish: "rendirse", example: "Nunca te rindas en tus sueños.", english_example: "Never give up on your dreams." },
            { english: "put off", spanish: "posponer", example: "No pospongas para mañana lo que puedes hacer hoy.", english_example: "Don't put off until tomorrow what you can do today." },
            { english: "look after", spanish: "cuidar de", example: "Mi hermana cuidó de mi perro mientras estaba de vacaciones.", english_example: "My sister looked after my dog while I was on vacation." },
            { english: "come across", spanish: "encontrarse con", example: "Me encontré con un viejo amigo en el supermercado.", english_example: "I came across an old friend at the supermarket." },
            { english: "run out of", spanish: "quedarse sin", example: "Nos hemos quedado sin leche.", english_example: "We have run out of milk." },
            { english: "take up", spanish: "empezar un hobby", example: "He empezado a tocar el piano.", english_example: "I have taken up playing the piano." },
            { english: "grow up", spanish: "crecer", example: "Él creció en la ciudad de Nueva York.", english_example: "He grew up in New York City." },
            { english: "hang out", spanish: "pasar el rato", example: "Nos gusta pasar el rato en la cafetería.", english_example: "We like to hang out at the cafe." },
            { english: "get along with", spanish: "llevarse bien con", example: "Me llevo bien con mi vecino.", english_example: "I get along with my neighbor." },
            { english: "look forward to", spanish: "estar deseando", example: "Estoy deseando verte la próxima semana.", english_example: "I am looking forward to seeing you next week." },
            { english: "put up with", spanish: "tolerar, aguantar", example: "No puedo aguantar su mala actitud.", english_example: "I can't put up with his bad attitude." }
        ];

        // Nuevo array de phrasal verbs del Reino Unido
        const ukPhrasalVerbs = [
            { english: "get off", spanish: "bajarse (de un bus, tren)", example: "Me bajé del autobús en la siguiente parada.", english_example: "I got off the bus at the next stop." },
            { english: "cheer on", spanish: "animar a", example: "Estuvimos animando a nuestro equipo favorito.", english_example: "We were cheering on our favorite team." },
            { english: "hold on", spanish: "esperar (en el teléfono)", example: "Espera un momento, por favor.", english_example: "Hold on a moment, please." },
            { english: "pop in", spanish: "pasar de visita", example: "Mi tía pasó de visita para tomar un té.", english_example: "My aunt popped in for a cup of tea." },
            { english: "send off", spanish: "expulsar (del campo de juego)", example: "El árbitro lo expulsó por una falta.", english_example: "The referee sent him off for a foul." },
            { english: "go off", spanish: "sonar (una alarma)", example: "La alarma sonó a las 6 de la mañana.", english_example: "The alarm went off at 6 in the morning." },
            { english: "bring up", spanish: "educar, criar", example: "Fui criado por mis abuelos.", english_example: "I was brought up by my grandparents." },
            { english: "look into", spanish: "investigar", example: "La policía está investigando el caso.", english_example: "The police are looking into the case." },
            { english: "fall out", spanish: "discutir con", example: "Ellos discutieron por un desacuerdo simple.", english_example: "They fell out over a simple disagreement." },
            { english: "get round to", spanish: "encontrar tiempo para", example: "Finalmente encontré tiempo para reparar la bicicleta.", english_example: "I finally got round to fixing the bike." },
        ];

        // Mensajes de motivación
        const motivationalMessages = [
            "¡Sigue así, estás progresando!",
            "Cada respuesta es un paso más hacia la fluidez.",
            "La práctica hace al maestro. ¡Muy bien!",
            "El esfuerzo de hoy es el éxito de mañana.",
            "¡No te rindas! Cada error es una oportunidad para aprender.",
            "El camino al dominio es largo, pero valdrá la pena.",
            "Estás construyendo tu vocabulario de manera excelente.",
            "Recuerda que cada pequeño paso cuenta.",
            "¡Tú puedes! El aprendizaje es un proceso continuo.",
            "La constancia es la clave. ¡Buen trabajo!",
        ];

        const englishMotivationalMessages = [
            "Keep it up, you're making progress!",
            "Every answer is one step closer to fluency.",
            "Practice makes perfect. Well done!",
            "Today's effort is tomorrow's success.",
            "Don't give up! Every mistake is a chance to learn.",
            "The path to mastery is long, but it will be worth it.",
            "You are building your vocabulary excellently.",
            "Remember that every small step counts.",
            "You can do it! Learning is a continuous process.",
            "Consistency is key. Great job!",
        ];

        let selectedVerbs = [];
        let shuffledVerbs = [];
        let currentIndex = 0;
        let score = 0;
        let totalAttempts = 0;
        let currentMode = 'selection';
        let choiceMade = false;
        let lastMotivationIndex = -1;
        // Objeto para almacenar el ejemplo dinámico generado por la IA y su traducción
        let currentDynamicExample = null;


        // Elementos del DOM
        const selectionContainer = document.getElementById("selection-container");
        const modeButtonsContainer = document.getElementById("mode-buttons-container");
        const modeSelection = document.getElementById("mode-selection");
        const quizContainer = document.getElementById("quiz-container");
        const writingContainer = document.getElementById("writing-container");
        const navButtonsContainer = document.getElementById("nav-buttons-container");
        const modalContainer = document.getElementById("modal-container");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalButton = document.getElementById("modal-button");

        const spanishDefinitionQuizEl = document.getElementById("spanish-definition-quiz");
        const exampleSentenceQuizEl = document.getElementById("example-sentence-quiz");
        const choicesContainer = document.getElementById("choices-container");
        const feedbackQuizEl = document.getElementById("feedback-quiz");
        const motivationContainerQuiz = document.getElementById("motivation-container-quiz");
        const motivationQuizEs = document.getElementById("motivation-quiz-es");
        const motivationQuizEn = document.getElementById("motivation-quiz-en");
        const scoreTextQuizEl = document.getElementById("score-text-quiz");
        const totalTextQuizEl = document.getElementById("total-text-quiz");
        const audioButtonQuiz = document.getElementById("audio-button-quiz");
        const speakerIconQuiz = document.getElementById("speaker-icon-quiz");
        const loadingTextQuiz = document.getElementById("loading-text-quiz");
        const geminiNewExampleButtonQuiz = document.getElementById("gemini-new-example-button-quiz");
        const geminiButtonTextQuiz = document.getElementById("gemini-button-text-quiz");
        const geminiSpinnerQuiz = document.getElementById("gemini-spinner-quiz");
        const geminiLoadingQuiz = document.getElementById("gemini-loading-quiz");


        const spanishDefinitionWritingEl = document.getElementById("spanish-definition-writing");
        const exampleSentenceWritingEl = document.getElementById("example-sentence-writing");
        const answerInput = document.getElementById("answer-input");
        const checkButton = document.getElementById("check-button");
        const feedbackWritingEl = document.getElementById("feedback-writing");
        const motivationContainerWriting = document.getElementById("motivation-container-writing");
        const motivationWritingEs = document.getElementById("motivation-writing-es");
        const motivationWritingEn = document.getElementById("motivation-writing-en");
        const answerRevealContainer = document.getElementById("answer-reveal-container");
        const correctAnswerText = document.getElementById("correct-answer-text");
        const audioButtonWriting = document.getElementById("audio-button-writing");
        const speakerIcon = document.getElementById("speaker-icon");
        const loadingText = document.getElementById("loading-text");
        const geminiCheckButtonWriting = document.getElementById("gemini-check-button-writing");
        const geminiCheckButtonText = document.getElementById("gemini-check-button-text");
        const geminiCheckSpinner = document.getElementById("gemini-check-spinner");
        const geminiFeedbackContainerWriting = document.getElementById("gemini-feedback-container-writing");
        const geminiFeedbackWriting = document.getElementById("gemini-feedback-writing");

        const modeButtons = document.querySelectorAll(".mode-button");
        const setButtons = document.querySelectorAll(".set-button");
        const backButton = document.getElementById("back-button");
        const nextButton = document.getElementById("next-button");
        const homeButton = document.getElementById("home-button");
        
        // Estado del texto de ejemplo para alternar entre español e inglés
        let quizExampleIsSpanish = true;
        let writingExampleIsSpanish = true;

        // Helper functions for TTS API
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * (bitsPerSample / 8);
            const byteRate = sampleRate * blockAlign;

            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            writeString('RIFF');
            view.setUint32(offset, 36 + pcmData.length * 2, true); offset += 4;
            writeString('WAVE');
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat
            view.setUint16(offset, numChannels, true); offset += 2; // NumChannels
            view.setUint32(offset, sampleRate, true); offset += 4; // SampleRate
            view.setUint32(offset, byteRate, true); offset += 4; // ByteRate
            view.setUint16(offset, blockAlign, true); offset += 2; // BlockAlign
            view.setUint16(offset, bitsPerSample, true); offset += 2; // BitsPerSample
            writeString('data');
            view.setUint32(offset, pcmData.length * 2, true); offset += 4;

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * La siguiente clave de API está vacía. El entorno de Canvas la proporcionará en tiempo de ejecución.
         */
        const apiKey = "AIzaSyDUcIYFkrk6nvZPXkNUYCeIu2w-9mmWRoc";
        const geminiTextApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const geminiTtsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;


        const fetchWithRetry = async (url, options, retries = 5, delay = 1000) => {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) {
                    console.warn(`Too many requests. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Network error. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        async function playPronunciation(text) {
            const audioBtn = (currentMode === 'quiz') ? audioButtonQuiz : audioButtonWriting;
            const icon = (currentMode === 'quiz') ? speakerIconQuiz : speakerIcon;
            const loadText = (currentMode === 'quiz') ? loadingTextQuiz : loadingText;

            // Evita que se activen varios audios a la vez
            if (audioBtn) audioBtn.disabled = true;
            if(icon) icon.classList.add("hidden");
            if(loadText) {
                loadText.classList.remove("hidden");
                loadText.textContent = "Cargando...";
            }

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Algenib" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetchWithRetry(geminiTtsApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    audio.onended = () => URL.revokeObjectURL(audioUrl);
                } else {
                    throw new Error("Invalid audio data from API.");
                }

            } catch (error) {
                console.error("Error al generar o reproducir el audio:", error);
                if(loadText) loadText.textContent = "Error";
            } finally {
                if(icon) icon.classList.remove("hidden");
                if(loadText) loadText.classList.add("hidden");
                if (audioBtn) audioBtn.disabled = false;
            }
        }
        
        // Función para obtener una traducción de una frase en inglés
        async function getEnglishTranslation(spanishText) {
            try {
                const prompt = `Traduce la siguiente oración del español al inglés de forma concisa. Solo da la traducción: "${spanishText}"`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                const response = await fetchWithRetry(geminiTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                return result?.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Error al obtener la traducción:", error);
                return null;
            }
        }


        // --- Nuevas funciones de la API de Gemini ---
        async function generateNewExample(phrasalVerb, definition) {
            geminiNewExampleButtonQuiz.disabled = true;
            geminiButtonTextQuiz.classList.add("hidden");
            geminiSpinnerQuiz.classList.remove("hidden");
            geminiLoadingQuiz.classList.remove("hidden");
            exampleSentenceQuizEl.textContent = "";

            try {
                // Genera un nuevo ejemplo en español
                const prompt = `Actúa como un tutor de inglés. Proporciona un nuevo y claro ejemplo de oración en español que use el phrasal verb "${phrasalVerb}". La definición es "${definition}". La oración debe ser diferente del ejemplo común y debe sonar natural. Proporciona solo la oración.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const response = await fetchWithRetry(geminiTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const newSpanishExample = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (newSpanishExample) {
                    // Obtiene la traducción al inglés del nuevo ejemplo
                    const newEnglishExample = await getEnglishTranslation(newSpanishExample);
                    
                    if (newEnglishExample) {
                        currentDynamicExample = { spanish: newSpanishExample, english: newEnglishExample };
                        exampleSentenceQuizEl.textContent = newSpanishExample;
                        quizExampleIsSpanish = true;
                    } else {
                        exampleSentenceQuizEl.textContent = newSpanishExample;
                        currentDynamicExample = { spanish: newSpanishExample, english: "Traducción no disponible." };
                        quizExampleIsSpanish = true;
                        console.error("No se pudo obtener la traducción al inglés.");
                    }
                } else {
                    exampleSentenceQuizEl.textContent = "No se pudo generar un nuevo ejemplo. Inténtalo de nuevo.";
                    currentDynamicExample = null;
                }
            } catch (error) {
                console.error("Error al generar un nuevo ejemplo:", error);
                exampleSentenceQuizEl.textContent = "Error de conexión. Inténtalo de nuevo más tarde.";
                currentDynamicExample = null;
            } finally {
                geminiNewExampleButtonQuiz.disabled = false;
                geminiButtonTextQuiz.classList.remove("hidden");
                geminiSpinnerQuiz.classList.add("hidden");
                geminiLoadingQuiz.classList.add("hidden");
            }
        }

        async function checkUserSentence(phrasalVerb, userSentence, definition) {
            geminiCheckButtonWriting.disabled = true;
            geminiCheckButtonText.classList.add("hidden");
            geminiCheckSpinner.classList.remove("hidden");

            try {
                const prompt = `Actúa como un tutor de gramática. Revisa la siguiente oración en español: "${userSentence}". El usuario debe usar el phrasal verb "${phrasalVerb}" (que significa "${definition}"). Proporciona feedback sobre la corrección de la gramática y el uso del phrasal verb. Si la oración es incorrecta, sugiere una forma de mejorarla. Responde en español, de forma concisa.`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };

                const response = await fetchWithRetry(geminiTextApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const feedback = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (feedback) {
                    geminiFeedbackWriting.textContent = feedback;
                    geminiFeedbackContainerWriting.classList.remove("hidden");
                } else {
                    geminiFeedbackWriting.textContent = "No se pudo generar feedback. Inténtalo de nuevo.";
                    geminiFeedbackContainerWriting.classList.remove("hidden");
                }

            } catch (error) {
                console.error("Error al verificar la oración:", error);
                geminiFeedbackWriting.textContent = "Error de conexión. Inténtalo de nuevo más tarde.";
                geminiFeedbackContainerWriting.classList.remove("hidden");
            } finally {
                geminiCheckButtonWriting.disabled = false;
                geminiCheckButtonText.classList.remove("hidden");
                geminiCheckSpinner.classList.add("hidden");
            }
        }


        // Función para mezclar el array (algoritmo Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getRandomMotivation() {
            const index = Math.floor(Math.random() * motivationalMessages.length);
            lastMotivationIndex = index;
            return {
                spanish: motivationalMessages[index],
                english: englishMotivationalMessages[index]
            };
        }

        // Muestra el modal de confirmación
        function showModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButton.onclick = () => {
                hideModal();
                onConfirm();
            };
            modalContainer.classList.remove("hidden");
        }

        // Oculta el modal de confirmación
        function hideModal() {
            modalContainer.classList.add("hidden");
        }


        function showSelectionMode() {
            currentMode = 'selection';
            selectionContainer.classList.remove("hidden");
            modeButtonsContainer.classList.remove("hidden");
            modeSelection.classList.add("hidden");
            quizContainer.classList.add("hidden");
            writingContainer.classList.add("hidden");
            navButtonsContainer.classList.add("hidden");
        }

        function showQuizSetSelection() {
            currentMode = 'quiz_selection';
            modeButtonsContainer.classList.add("hidden");
            selectionContainer.classList.remove("hidden");
            modeSelection.classList.remove("hidden");
            quizContainer.classList.add("hidden");
            writingContainer.classList.add("hidden");
            navButtonsContainer.classList.add("hidden");
        }

        function showWritingSetSelection() {
            currentMode = 'writing_selection';
            modeButtonsContainer.classList.add("hidden");
            selectionContainer.classList.remove("hidden");
            modeSelection.classList.remove("hidden");
            quizContainer.classList.add("hidden");
            writingContainer.classList.add("hidden");
            navButtonsContainer.classList.add("hidden");
        }

        // --- Lógica del Modo Examen ---
        function startQuiz() {
            currentMode = 'quiz';
            selectionContainer.classList.add("hidden");
            quizContainer.classList.remove("hidden");
            navButtonsContainer.classList.remove("hidden");
            shuffledVerbs = shuffleArray([...selectedVerbs]);
            currentIndex = 0;
            score = 0;
            totalAttempts = 0;
            updateQuizScore();
            showQuizCard();
        }

        function showQuizCard() {
            if (currentIndex < 0) {
                currentIndex = 0;
                return;
            }
            if (currentIndex >= shuffledVerbs.length) {
                showModal("¡Set Completado!", `Has completado todas las tarjetas. Puntuación final: ${score} de ${totalAttempts}.`, () => startQuiz());
                return;
            }
            const currentVerb = shuffledVerbs[currentIndex];
            spanishDefinitionQuizEl.textContent = currentVerb.spanish;
            exampleSentenceQuizEl.textContent = currentVerb.example;
            feedbackQuizEl.textContent = "";
            motivationQuizEs.textContent = "";
            motivationQuizEn.textContent = "";
            motivationQuizEn.classList.add("hidden");
            choiceMade = false;
            quizExampleIsSpanish = true;
            // Reinicia el ejemplo dinámico
            currentDynamicExample = null;
            updateNavButtons();
            generateChoices(currentVerb.english);
        }

        function generateChoices(correctAnswer) {
            choicesContainer.innerHTML = "";
            const incorrectOptions = selectedVerbs
                .filter(verb => verb.english !== correctAnswer)
                .map(verb => verb.english);
            
            const randomIncorrect = shuffleArray(incorrectOptions).slice(0, 3);
            const options = shuffleArray([...randomIncorrect, correctAnswer]);

            options.forEach(option => {
                const button = document.createElement("button");
                button.textContent = option;
                button.classList.add("bg-gray-700", "hover:bg-gray-600", "text-white", "font-bold", "py-3", "px-6", "rounded-xl", "shadow-lg", "transition-colors", "duration-200", "w-full");
                button.addEventListener("click", () => checkQuizAnswer(option, correctAnswer, button));
                choicesContainer.appendChild(button);
            });
        }

        function checkQuizAnswer(selectedOption, correctAnswer, button) {
            if (choiceMade) return;
            choiceMade = true;
            totalAttempts++;

            Array.from(choicesContainer.children).forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                score++;
                feedbackQuizEl.textContent = "¡Correcto!";
                feedbackQuizEl.classList.remove("text-red-400");
                feedbackQuizEl.classList.add("text-green-400");
                button.classList.remove("bg-gray-700", "hover:bg-gray-600");
                button.classList.add("bg-green-600", "text-white");
            } else {
                feedbackQuizEl.textContent = `Incorrecto. La respuesta correcta es "${correctAnswer}".`;
                feedbackQuizEl.classList.remove("text-green-400");
                feedbackQuizEl.classList.add("text-red-400");
                button.classList.remove("bg-gray-700", "hover:bg-gray-600");
                button.classList.add("bg-red-600", "text-white");

                const correctButton = Array.from(choicesContainer.children).find(btn => btn.textContent === correctAnswer);
                if (correctButton) {
                    correctButton.classList.remove("bg-gray-700", "hover:bg-gray-600");
                    correctButton.classList.add("bg-green-600", "text-white");
                }
            }
            
            const motivation = getRandomMotivation();
            motivationQuizEs.textContent = motivation.spanish;
            motivationQuizEn.textContent = motivation.english;
            updateQuizScore();
        }

        function updateQuizScore() {
            scoreTextQuizEl.textContent = "Puntuación: " + score;
            totalTextQuizEl.textContent = totalAttempts;
        }

        // --- Lógica del Modo Escritura ---
        function startWritingPractice() {
            currentMode = 'writing';
            selectionContainer.classList.add("hidden");
            writingContainer.classList.remove("hidden");
            navButtonsContainer.classList.remove("hidden");
            shuffledVerbs = shuffleArray([...selectedVerbs]);
            currentIndex = 0;
            showWritingCard();
        }

        function showWritingCard() {
            if (currentIndex < 0) {
                currentIndex = 0;
                return;
            }
            if (currentIndex >= shuffledVerbs.length) {
                showModal("¡Set Completado!", "Has completado todas las tarjetas. ¡Sigue practicando!", () => startWritingPractice());
                return;
            }

            const currentVerb = shuffledVerbs[currentIndex];
            spanishDefinitionWritingEl.textContent = currentVerb.spanish;
            exampleSentenceWritingEl.textContent = currentVerb.example;
            
            answerInput.value = "";
            answerInput.disabled = false;
            checkButton.classList.remove("hidden");
            answerRevealContainer.classList.add("hidden");
            feedbackWritingEl.textContent = "";
            motivationWritingEs.textContent = "";
            motivationWritingEn.textContent = "";
            motivationWritingEn.classList.add("hidden");
            writingExampleIsSpanish = true;
            geminiFeedbackContainerWriting.classList.add("hidden");
            updateNavButtons();
        }

        function checkWritingAnswer() {
            const currentVerb = shuffledVerbs[currentIndex];
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswer = currentVerb.english.toLowerCase();
            const motivation = getRandomMotivation();

            answerInput.disabled = true;
            checkButton.classList.add("hidden");
            answerRevealContainer.classList.remove("hidden");
            geminiCheckButtonWriting.classList.add("hidden");
            correctAnswerText.textContent = currentVerb.english;
            
            if (userAnswer === correctAnswer) {
                feedbackWritingEl.textContent = "¡Correcto! ¡Excelente!";
                feedbackWritingEl.classList.remove("text-red-400");
                feedbackWritingEl.classList.add("text-green-400");
            } else {
                feedbackWritingEl.textContent = "Incorrecto. ¡No te rindas! Inténtalo de nuevo.";
                feedbackWritingEl.classList.remove("text-green-400");
                feedbackWritingEl.classList.add("text-red-400");
            }

            motivationWritingEs.textContent = motivation.spanish;
            motivationWritingEn.textContent = motivation.english;
        }

        // Función para alternar el texto de ejemplo
        function toggleExampleSentence(mode) {
            const currentVerb = shuffledVerbs[currentIndex];

            if (mode === 'quiz') {
                if (currentDynamicExample) {
                    // Si hay un ejemplo dinámico, alternar entre su versión en español e inglés
                    const textToDisplay = quizExampleIsSpanish ? currentDynamicExample.english : currentDynamicExample.spanish;
                    exampleSentenceQuizEl.textContent = textToDisplay;
                    playPronunciation(textToDisplay);
                    quizExampleIsSpanish = !quizExampleIsSpanish;
                } else {
                    // Si no, usar los ejemplos estáticos
                    const textToDisplay = quizExampleIsSpanish ? currentVerb.english_example : currentVerb.example;
                    exampleSentenceQuizEl.textContent = textToDisplay;
                    playPronunciation(textToDisplay);
                    quizExampleIsSpanish = !quizExampleIsSpanish;
                }
            } else if (mode === 'writing') {
                const textToDisplay = writingExampleIsSpanish ? currentVerb.english_example : currentVerb.example;
                exampleSentenceWritingEl.textContent = textToDisplay;
                playPronunciation(textToDisplay);
                writingExampleIsSpanish = !writingExampleIsSpanish;
            }
        }


        // --- Manejo de Eventos ---
        modeButtons.forEach(button => {
            button.addEventListener("click", () => {
                const mode = button.getAttribute("data-mode");
                if (mode === 'quiz') {
                    showQuizSetSelection();
                } else {
                    showWritingSetSelection();
                }
            });
        });

        setButtons.forEach(button => {
            button.addEventListener("click", () => {
                const set = button.getAttribute("data-set");
                if (set === 'us') {
                    selectedVerbs = usPhrasalVerbs;
                } else if (set === 'uk') {
                    selectedVerbs = ukPhrasalVerbs;
                } else {
                    selectedVerbs = [...usPhrasalVerbs, ...ukPhrasalVerbs];
                }

                if (currentMode === 'quiz_selection') {
                    startQuiz();
                } else if (currentMode === 'writing_selection') {
                    startWritingPractice();
                }
            });
        });

        nextButton.addEventListener("click", () => {
            currentIndex++;
            if (currentMode === 'quiz') {
                showQuizCard();
            } else if (currentMode === 'writing') {
                showWritingCard();
            }
        });

        backButton.addEventListener("click", () => {
            currentIndex--;
            if (currentMode === 'quiz') {
                showQuizCard();
            } else if (currentMode === 'writing') {
                showWritingCard();
            }
        });

        homeButton.addEventListener("click", () => {
            showSelectionMode();
        });

        checkButton.addEventListener("click", checkWritingAnswer);

        // Enter key for writing mode
        answerInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter" && answerInput.value.trim() !== "") {
                checkWritingAnswer();
            }
        });

        // Toggle example sentence listener
        exampleSentenceQuizEl.addEventListener("click", () => toggleExampleSentence('quiz'));
        exampleSentenceWritingEl.addEventListener("click", () => toggleExampleSentence('writing'));

        // Toggle motivation message listener
        motivationContainerQuiz.addEventListener("click", () => {
            const isEnglishHidden = motivationQuizEn.classList.contains("hidden");
            if (isEnglishHidden) {
                // Va a cambiar a inglés, reproduce el audio en inglés
                playPronunciation(motivationQuizEn.textContent);
            } else {
                // Va a cambiar a español, reproduce el audio en español
                playPronunciation(motivationQuizEs.textContent);
            }
            motivationQuizEs.classList.toggle("hidden");
            motivationQuizEn.classList.toggle("hidden");
        });
        
        motivationContainerWriting.addEventListener("click", () => {
            const isEnglishHidden = motivationWritingEn.classList.contains("hidden");
            if (isEnglishHidden) {
                // Va a cambiar a inglés, reproduce el audio en inglés
                playPronunciation(motivationWritingEn.textContent);
            } else {
                // Va a cambiar a español, reproduce el audio en español
                playPronunciation(motivationWritingEs.textContent);
            }
            motivationWritingEs.classList.toggle("hidden");
            motivationWritingEn.classList.toggle("hidden");
        });
        
        audioButtonQuiz.addEventListener("click", () => {
            const currentVerb = shuffledVerbs[currentIndex];
            playPronunciation(currentVerb.english);
        });

        audioButtonWriting.addEventListener("click", () => {
            const currentVerb = shuffledVerbs[currentIndex];
            playPronunciation(currentVerb.english);
        });
        
        // Listeners for new Gemini features
        geminiNewExampleButtonQuiz.addEventListener("click", () => {
            const currentVerb = shuffledVerbs[currentIndex];
            if (currentVerb) {
                generateNewExample(currentVerb.english, currentVerb.spanish);
            }
        });

        geminiCheckButtonWriting.addEventListener("click", () => {
            const currentVerb = shuffledVerbs[currentIndex];
            const userAnswer = answerInput.value.trim();
            if (currentVerb && userAnswer) {
                checkUserSentence(currentVerb.english, userAnswer, currentVerb.spanish);
            }
        });


        // Función para actualizar el estado de los botones de navegación
        function updateNavButtons() {
            backButton.disabled = currentIndex === 0;
            nextButton.disabled = choiceMade && currentMode === 'quiz';
        }

        // Inicializar la aplicación en el modo de selección
        showSelectionMode();
    </script>
</body>
</html>

